---
- name: Install system dependencies (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "{{ linux_system_packages }}"
    state: present
    update_cache: true
  become: true
  when: ansible_os_family == "Debian"

- name: Check if Homebrew is installed
  ansible.builtin.stat:
    path: "{{ homebrew_prefix }}/bin/brew"
  register: homebrew_check

- name: Install Homebrew (Linux)
  ansible.builtin.shell: |
    /bin/bash -c "$(curl -fsSL {{ homebrew_install_url }})"
  when: not homebrew_check.stat.exists
  become: false
  environment:
    NONINTERACTIVE: "1"

- name: Ensure Homebrew is in PATH
  ansible.builtin.lineinfile:
    path: "{{ dotfiles_home }}/.zprofile"
    line: 'eval "$({{ homebrew_prefix }}/bin/brew shellenv)"'
    create: true
    mode: '0644'

- name: Update Homebrew
  community.general.homebrew:
    update_homebrew: true
    path: "{{ homebrew_prefix }}/bin"
  when: homebrew_check.stat.exists

- name: Copy Brewfile to home directory
  ansible.builtin.copy:
    src: Brewfile.linux
    dest: "{{ dotfiles_home }}/Brewfile"
    mode: '0644'

- name: Install packages from Brewfile
  ansible.builtin.command:
    cmd: "{{ homebrew_prefix }}/bin/brew bundle --file={{ dotfiles_home }}/Brewfile"
  register: brew_bundle_result
  changed_when: "'Installing' in brew_bundle_result.stdout or 'Upgrading' in brew_bundle_result.stdout"
  failed_when: brew_bundle_result.rc != 0
