---
- name: Configure dotfiles and system setup
  hosts: localhost
  connection: local
  gather_facts: true

  pre_tasks:
    - name: Display detected operating system
      ansible.builtin.debug:
        msg: |
          Operating System: {{ ansible_os_family }}
          Distribution: {{ ansible_distribution | default('N/A') }}
          Version: {{ ansible_distribution_version | default('N/A') }}
          Architecture: {{ ansible_machine }}

    - name: Update Homebrew (macOS)
      community.general.homebrew:
        update_homebrew: true
      when: ansible_os_family == "Darwin"
      tags: [homebrew, packages]

    - name: Update package cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      become: true
      when: ansible_os_family == "Debian"
      tags: [packages]

    - name: Create common directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ config_directories }}"
      tags: [always]

  roles:
    - role: homebrew
      when: configure_homebrew | bool
      tags: [homebrew, packages]

    - role: zsh
      when: configure_zsh | bool
      tags: [zsh, shell]

    - role: bash
      when: configure_bash | bool
      tags: [bash, shell]

    - role: tmux
      when: configure_tmux | bool
      tags: [tmux]

    - role: neovim
      when: configure_neovim | bool
      tags: [neovim, nvim, editor]

    - role: ghostty
      when: configure_ghostty | bool
      tags: [ghostty, terminal]

    - role: aerospace
      when:
        - configure_aerospace | bool
        - ansible_os_family == "Darwin"
      tags: [aerospace, wm, macos]

    - role: macos-settings
      when:
        - configure_macos_settings | bool
        - ansible_os_family == "Darwin"
      tags: [macos, settings, macos-settings]

  post_tasks:
    - name: Display completion message
      ansible.builtin.debug:
        msg: |
          ========================================
          Dotfiles setup complete!
          ========================================

          Next steps:
          1. Restart your shell or run: exec $SHELL
          2. If using tmux, press prefix + I to install plugins
          3. Launch neovim to install plugins automatically
          4. On macOS, log out and back in to apply all system settings

          To update your configuration later, run:
            ./scripts/update.sh

          To run specific components only, use tags:
            ansible-playbook playbooks/main.yml --tags tmux
            ansible-playbook playbooks/main.yml --tags neovim
            ansible-playbook playbooks/main.yml --tags macos

          ========================================
